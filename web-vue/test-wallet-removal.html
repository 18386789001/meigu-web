<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…ä»£ç åˆ é™¤éªŒè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.2em;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        
        .test-item.pass {
            border-left-color: #28a745;
        }
        
        .test-item.fail {
            border-left-color: #dc3545;
        }
        
        .test-result {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
        }
        
        .test-result.pass {
            background: #28a745;
        }
        
        .test-result.fail {
            background: #dc3545;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .error-log {
            color: #ff6b6b;
        }
        
        .success-log {
            color: #51cf66;
        }
        
        .warning-log {
            color: #ffd43b;
        }
        
        .info-log {
            color: #74c0fc;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }
        
        .summary h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é’±åŒ…ä»£ç åˆ é™¤éªŒè¯</h1>
        <p class="subtitle">éªŒè¯web-vueé¡¹ç›®ä¸­çš„é’±åŒ…æ‰©å±•ä»£ç æ˜¯å¦å·²å®Œå…¨åˆ é™¤</p>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ¦‚è§ˆ</h2>
            <div id="overallStatus" class="status">æ­£åœ¨æ£€æµ‹...</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ” ä»£ç æ£€æµ‹</h2>
            <div id="codeTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸŒ ç½‘ç»œè¯·æ±‚æ£€æµ‹</h2>
            <div id="networkTests"></div>
            <button class="btn" onclick="checkNetworkRequests()">æ£€æŸ¥ç½‘ç»œè¯·æ±‚</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ æ§åˆ¶å°é”™è¯¯ç›‘æ§</h2>
            <div id="consoleStatus" class="status">ç›‘æ§ä¸­...</div>
            <div class="console-output" id="consoleOutput"></div>
            <button class="btn" onclick="clearConsoleOutput()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ§ª æ¨¡æ‹Ÿé’±åŒ…é”™è¯¯æµ‹è¯•</h2>
            <p>æµ‹è¯•é”™è¯¯è¿‡æ»¤å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š</p>
            <button class="btn" onclick="simulateWalletError('Sender')">æ¨¡æ‹ŸSenderé”™è¯¯</button>
            <button class="btn" onclick="simulateWalletError('Talisman')">æ¨¡æ‹ŸTalismané”™è¯¯</button>
            <button class="btn" onclick="simulateWalletError('polkadot')">æ¨¡æ‹ŸPolkadoté”™è¯¯</button>
        </div>
        
        <div class="summary" id="summary">
            <h3>æ£€æµ‹å®Œæˆ</h3>
            <p id="summaryText">é’±åŒ…ä»£ç åˆ é™¤éªŒè¯ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º</p>
        </div>
    </div>

    <script>
        let consoleErrors = [];
        let testResults = {
            codeTests: [],
            networkTests: [],
            consoleTests: []
        };
        
        // åˆå§‹åŒ–æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            initializeTests();
            setupConsoleMonitoring();
            runCodeTests();
            setTimeout(updateSummary, 2000);
        });
        
        // åˆå§‹åŒ–æµ‹è¯•
        function initializeTests() {
            console.log('ğŸ” å¼€å§‹é’±åŒ…ä»£ç åˆ é™¤éªŒè¯æµ‹è¯•');
        }
        
        // è®¾ç½®æ§åˆ¶å°ç›‘æ§
        function setupConsoleMonitoring() {
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalLog = console.log;
            
            console.error = function(...args) {
                logToConsoleOutput('error', args.join(' '));
                checkForWalletErrors(args.join(' '));
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                logToConsoleOutput('warning', args.join(' '));
                checkForWalletErrors(args.join(' '));
                originalWarn.apply(console, args);
            };
            
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('wallet') || message.includes('Wallet')) {
                    logToConsoleOutput('info', message);
                }
                originalLog.apply(console, args);
            };
            
            // ç›‘å¬æœªæ•è·çš„é”™è¯¯
            window.addEventListener('error', function(event) {
                logToConsoleOutput('error', `æœªæ•è·é”™è¯¯: ${event.message}`);
                checkForWalletErrors(event.message);
            });
            
            // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
            window.addEventListener('unhandledrejection', function(event) {
                logToConsoleOutput('error', `æœªå¤„ç†Promiseæ‹’ç»: ${event.reason}`);
                checkForWalletErrors(event.reason?.message || event.reason);
            });
        }
        
        // è®°å½•åˆ°æ§åˆ¶å°è¾“å‡º
        function logToConsoleOutput(type, message) {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error-log' : 
                            type === 'warning' ? 'warning-log' : 
                            type === 'info' ? 'info-log' : 'success-log';
            
            output.innerHTML += `<div class="${className}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // æ£€æŸ¥é’±åŒ…ç›¸å…³é”™è¯¯
        function checkForWalletErrors(message) {
            const walletKeywords = [
                'walletDetector', 'WalletDetector', 'checkWalletAvailability',
                'Sender', 'Talisman', 'polkadot', 'wallet', 'extension',
                'Failed to get initial state', 'not been configured'
            ];
            
            const hasWalletError = walletKeywords.some(keyword => 
                message.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (hasWalletError) {
                consoleErrors.push({
                    message: message,
                    timestamp: new Date().toISOString(),
                    type: 'wallet'
                });
                updateConsoleStatus();
            }
        }
        
        // æ›´æ–°æ§åˆ¶å°çŠ¶æ€
        function updateConsoleStatus() {
            const statusEl = document.getElementById('consoleStatus');
            const walletErrors = consoleErrors.filter(e => e.type === 'wallet');
            
            if (walletErrors.length === 0) {
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… æœªæ£€æµ‹åˆ°é’±åŒ…ç›¸å…³é”™è¯¯';
            } else {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æ£€æµ‹åˆ° ${walletErrors.length} ä¸ªé’±åŒ…ç›¸å…³é”™è¯¯`;
            }
        }
        
        // è¿è¡Œä»£ç æ£€æµ‹æµ‹è¯•
        function runCodeTests() {
            const tests = [
                {
                    name: 'æ£€æŸ¥window.walletDetectoræ˜¯å¦å­˜åœ¨',
                    test: () => typeof window.walletDetector === 'undefined',
                    expected: true
                },
                {
                    name: 'æ£€æŸ¥walletDetectoræ¨¡å—æ˜¯å¦è¢«åŠ è½½',
                    test: () => {
                        try {
                            // å°è¯•è®¿é—®walletDetectorç›¸å…³çš„å…¨å±€å˜é‡
                            return typeof window.checkWalletAvailability === 'undefined';
                        } catch (e) {
                            return true; // å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œè¯´æ˜æ²¡æœ‰è¢«åŠ è½½
                        }
                    },
                    expected: true
                },
                {
                    name: 'æ£€æŸ¥æ˜¯å¦æœ‰é’±åŒ…ç›¸å…³çš„å…¨å±€å‡½æ•°',
                    test: () => {
                        const walletFunctions = [
                            'checkWalletAvailability',
                            'hasAnyWallet',
                            'getWalletStatus',
                            'connectWallet'
                        ];
                        return walletFunctions.every(fn => typeof window[fn] === 'undefined');
                    },
                    expected: true
                },
                {
                    name: 'æ£€æŸ¥documentä¸­æ˜¯å¦æœ‰é’±åŒ…ç›¸å…³çš„è„šæœ¬æ ‡ç­¾',
                    test: () => {
                        const scripts = Array.from(document.querySelectorAll('script'));
                        return !scripts.some(script => 
                            script.src.includes('walletDetector') || 
                            script.textContent.includes('walletDetector')
                        );
                    },
                    expected: true
                }
            ];
            
            const container = document.getElementById('codeTests');
            container.innerHTML = '';
            
            tests.forEach(test => {
                const result = test.test();
                const passed = result === test.expected;
                
                testResults.codeTests.push({
                    name: test.name,
                    passed: passed,
                    result: result
                });
                
                const testItem = document.createElement('div');
                testItem.className = `test-item ${passed ? 'pass' : 'fail'}`;
                testItem.innerHTML = `
                    <span>${test.name}</span>
                    <span class="test-result ${passed ? 'pass' : 'fail'}">
                        ${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                    </span>
                `;
                container.appendChild(testItem);
            });
        }
        
        // æ£€æŸ¥ç½‘ç»œè¯·æ±‚
        function checkNetworkRequests() {
            const container = document.getElementById('networkTests');
            container.innerHTML = '<div class="status">æ­£åœ¨æ£€æŸ¥ç½‘ç»œè¯·æ±‚...</div>';
            
            // æ£€æŸ¥Performance APIä¸­çš„èµ„æº
            const resources = performance.getEntriesByType('resource');
            const walletResources = resources.filter(resource => 
                resource.name.includes('walletDetector') ||
                resource.name.includes('wallet') && resource.name.includes('.js')
            );
            
            setTimeout(() => {
                if (walletResources.length === 0) {
                    container.innerHTML = `
                        <div class="test-item pass">
                            <span>ç½‘ç»œè¯·æ±‚æ£€æŸ¥</span>
                            <span class="test-result pass">âœ… æœªå‘ç°é’±åŒ…ç›¸å…³çš„ç½‘ç»œè¯·æ±‚</span>
                        </div>
                    `;
                    testResults.networkTests.push({
                        name: 'ç½‘ç»œè¯·æ±‚æ£€æŸ¥',
                        passed: true,
                        result: 'æ— é’±åŒ…ç›¸å…³è¯·æ±‚'
                    });
                } else {
                    container.innerHTML = `
                        <div class="test-item fail">
                            <span>ç½‘ç»œè¯·æ±‚æ£€æŸ¥</span>
                            <span class="test-result fail">âŒ å‘ç° ${walletResources.length} ä¸ªé’±åŒ…ç›¸å…³è¯·æ±‚</span>
                        </div>
                        <div class="console-output">
                            ${walletResources.map(r => `<div class="error-log">${r.name}</div>`).join('')}
                        </div>
                    `;
                    testResults.networkTests.push({
                        name: 'ç½‘ç»œè¯·æ±‚æ£€æŸ¥',
                        passed: false,
                        result: `å‘ç°${walletResources.length}ä¸ªé’±åŒ…è¯·æ±‚`
                    });
                }
                updateSummary();
            }, 1000);
        }
        
        // æ¨¡æ‹Ÿé’±åŒ…é”™è¯¯
        function simulateWalletError(walletType) {
            const errorMessages = {
                'Sender': 'Sender: Failed to get initial state. Please report this bug.',
                'Talisman': 'Talisman extension has not been configured yet. Please continue with onboarding.',
                'polkadot': 'Disconnected from polkadot{.js} extension'
            };
            
            const message = errorMessages[walletType];
            logToConsoleOutput('error', `æ¨¡æ‹Ÿ${walletType}é”™è¯¯: ${message}`);
            
            // è§¦å‘é”™è¯¯äº‹ä»¶
            const errorEvent = new ErrorEvent('error', {
                message: message,
                filename: 'test',
                lineno: 1,
                colno: 1
            });
            window.dispatchEvent(errorEvent);
        }
        
        // æ¸…é™¤æ§åˆ¶å°è¾“å‡º
        function clearConsoleOutput() {
            document.getElementById('consoleOutput').innerHTML = '';
            consoleErrors = [];
            updateConsoleStatus();
        }
        
        // æ›´æ–°æ€»ç»“
        function updateSummary() {
            const totalTests = testResults.codeTests.length + testResults.networkTests.length;
            const passedTests = testResults.codeTests.filter(t => t.passed).length + 
                              testResults.networkTests.filter(t => t.passed).length;
            
            const walletErrors = consoleErrors.filter(e => e.type === 'wallet').length;
            
            const summaryEl = document.getElementById('summaryText');
            const overallStatusEl = document.getElementById('overallStatus');
            
            if (passedTests === totalTests && walletErrors === 0) {
                overallStatusEl.className = 'status success';
                overallStatusEl.textContent = 'âœ… é’±åŒ…ä»£ç åˆ é™¤æˆåŠŸï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡';
                
                summaryEl.innerHTML = `
                    <strong>ğŸ‰ åˆ é™¤æˆåŠŸï¼</strong><br>
                    ä»£ç æµ‹è¯•: ${passedTests}/${totalTests} é€šè¿‡<br>
                    æ§åˆ¶å°é”™è¯¯: ${walletErrors} ä¸ªé’±åŒ…ç›¸å…³é”™è¯¯<br>
                    çŠ¶æ€: é’±åŒ…æ‰©å±•ä»£ç å·²å®Œå…¨åˆ é™¤
                `;
            } else {
                overallStatusEl.className = 'status error';
                overallStatusEl.textContent = 'âŒ æ£€æµ‹åˆ°é—®é¢˜ï¼Œé’±åŒ…ä»£ç å¯èƒ½æœªå®Œå…¨åˆ é™¤';
                
                summaryEl.innerHTML = `
                    <strong>âš ï¸ éœ€è¦æ³¨æ„ï¼</strong><br>
                    ä»£ç æµ‹è¯•: ${passedTests}/${totalTests} é€šè¿‡<br>
                    æ§åˆ¶å°é”™è¯¯: ${walletErrors} ä¸ªé’±åŒ…ç›¸å…³é”™è¯¯<br>
                    çŠ¶æ€: å¯èƒ½è¿˜æœ‰æ®‹ç•™çš„é’±åŒ…ä»£ç 
                `;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        setTimeout(() => {
            logToConsoleOutput('success', 'é’±åŒ…ä»£ç åˆ é™¤éªŒè¯æµ‹è¯•å·²å¯åŠ¨');
            updateConsoleStatus();
        }, 1000);
    </script>
</body>
</html>
