# 🚨 MT5生产环境403错误紧急修复部署指南

## 📋 当前问题
生产环境仍然出现403认证错误：
```json
{"code":403,"msg":"您的账号已过期或已经在其他地方登录，请重新登录","succeed":false}
```

## 🔥 立即修复方案

### 方案1: 部署前端认证修复脚本（推荐，立即生效）

#### 步骤1: 将修复脚本添加到生产环境

1. **复制修复脚本到生产环境**：
   - 将 `fix-auth-403.js` 文件上传到您的生产环境
   - 建议放在静态资源目录中，如：`/static/js/fix-auth-403.js`

2. **在HTML中引入脚本**：
   在 `web-vue/index.html` 中添加：
   ```html
   <script src="/static/js/fix-auth-403.js"></script>
   ```
   
   在 `h5-vue/index.html` 中添加：
   ```html
   <script src="/static/js/fix-auth-403.js"></script>
   ```

3. **重新构建和部署**：
   ```bash
   # 构建项目
   yarn build
   
   # 部署到生产环境
   ```

#### 步骤2: 验证修复效果

修复脚本会自动：
- ✅ 增强Token管理
- ✅ 自动处理403错误
- ✅ 提供友好的用户提示
- ✅ 自动跳转到登录页
- ✅ 定期检查认证状态

### 方案2: 修改现有代码（需要重新构建）

如果您希望直接修改代码而不是添加脚本，可以：

#### 修改web-vue的HTTP拦截器

在 `web-vue/src/utils/http.js` 中，我已经优化了403错误处理。确保以下代码已正确部署：

```javascript
// 403错误处理已优化
if (response.data.code == "403" || response.data.code == "401") {
  // 根据错误消息显示不同的提示
  let errorMessage = response.data.msg;
  if (errorMessage.includes("账号已过期") || errorMessage.includes("已经在其他地方登录")) {
    errorMessage = "您的账号已过期或已在其他设备登录，请重新登录";
  }
  handleClearLoginInfo(errorMessage);
}
```

#### 修改h5-vue的HTTP拦截器

在 `h5-vue/src/api/request.js` 中，确保403错误处理已优化：

```javascript
case 403:
  // 检查是否是认证过期错误
  if (data?.msg && (data.msg.includes('账号已过期') || data.msg.includes('已经在其他地方登录'))) {
    message = '您的账号已过期或已在其他设备登录，请重新登录';
  } else {
    message = data?.msg || '拒绝访问';
  }
  // 清除认证信息并跳转
  localStorage.removeItem('token');
  localStorage.removeItem('userInfo');
  setTimeout(() => {
    window.location.href = '/login';
  }, 1500);
  break;
```

## 🎯 后端根本解决方案（强烈推荐）

### 立即检查后端配置

1. **检查Token过期时间**：
   ```java
   // 确保Token有效期足够长（建议24小时）
   JwtUtil.createToken(userInfo, 24 * 60 * 60 * 1000L);
   ```

2. **添加Token刷新机制**：
   ```java
   @PostMapping("/refresh-token")
   public Result refreshToken(@RequestHeader("refresh-token") String refreshToken) {
       // 实现Token刷新逻辑
   }
   ```

3. **优化错误响应**：
   ```java
   // 确保403错误返回正确的格式
   return Result.error(403, "登录状态已过期，请重新登录");
   ```

## 🚀 快速部署命令

### 1. 立即部署修复脚本
```bash
# 1. 上传修复脚本到生产环境
scp fix-auth-403.js user@server:/path/to/static/js/

# 2. 修改HTML文件添加脚本引用
# 3. 重新构建项目
yarn build

# 4. 部署到生产环境
```

### 2. 验证修复效果
```bash
# 检查修复脚本是否加载
curl -I https://jpmx.xyz/static/js/fix-auth-403.js

# 检查控制台是否有初始化日志
# 应该看到: "✅ MT5认证修复系统初始化完成"
```

## 📊 测试验证

### 1. 功能测试
- ✅ 访问生产环境，检查控制台是否显示修复脚本加载成功
- ✅ 模拟Token过期，检查是否显示友好提示
- ✅ 测试自动跳转到登录页功能

### 2. 错误处理测试
- ✅ 检查403错误是否被优雅处理
- ✅ 检查用户是否看到友好的中文提示
- ✅ 检查是否自动清除认证信息

### 3. 调试功能
修复脚本会在控制台暴露调试方法：
```javascript
// 在浏览器控制台中使用
window.MT5AuthDebug.getToken();     // 获取当前Token
window.MT5AuthDebug.clearAuth();    // 清除认证信息
window.MT5AuthDebug.checkAuth();    // 检查认证状态
```

## 🔍 问题排查

### 如果修复后仍有403错误：

1. **检查后端Token验证逻辑**：
   - Token过期时间是否过短
   - Token格式是否正确
   - 后端验证逻辑是否有问题

2. **检查网络请求**：
   - Token是否正确发送到后端
   - 请求头格式是否正确
   - 跨域配置是否正确

3. **检查浏览器控制台**：
   - 是否有JavaScript错误
   - 修复脚本是否正确加载
   - 是否有网络请求失败

## 📞 紧急支持

如果问题仍然存在，请：

1. **提供后端日志**：查看具体的Token验证失败原因
2. **检查数据库连接**：确认用户会话数据是否正常
3. **验证API接口**：确认后端接口是否正常工作
4. **检查服务器配置**：确认Nginx/Apache配置是否正确

## 🎯 预期效果

修复完成后，您应该看到：

1. ✅ 403错误被优雅处理，不再显示原始错误信息
2. ✅ 用户看到友好的中文提示："您的账号已过期或已在其他设备登录，请重新登录"
3. ✅ 自动跳转到登录页，无需用户手动操作
4. ✅ Token管理更加稳定，减少频繁登录问题
5. ✅ 整体用户体验显著提升

建议优先部署前端修复脚本，这样可以立即改善用户体验，同时与后端团队协作解决根本问题。
