# 🌐 H5-Vue 到 WAP-Vue 语言参数传递完整方案

## 📋 方案概述

实现从 H5-Vue 应用到 WAP-Vue 应用的语言参数自动传递，支持开发环境和生产环境自动切换。

---

## 🎯 实现目标

### 1. **环境自动检测**
- ✅ 开发环境：自动跳转到 `http://localhost:333/syn/#/my/index?lang=xxx`
- ✅ 生产环境：自动跳转到 `https://jpmx.xyz/syn/#/my/index?lang=xxx`

### 2. **语言参数传递**
- ✅ H5-Vue 选择语言后点击"登录"或"注册"按钮
- ✅ 自动将语言参数附加到跳转 URL
- ✅ WAP-Vue 自动识别并应用语言参数

### 3. **语言映射**
- ✅ 支持 13 种语言的代码映射
- ✅ H5-Vue 和 WAP-Vue 语言代码标准不同，自动转换

---

## 🔧 技术实现

### 修改文件清单

#### 1. **h5-vue/src/utils/domainManager.js** ✅
**功能**：环境自动检测，生成正确的 WAP-Vue URL

```javascript
// WAP端URL生成器
const generateWapUrl = (path = '', params = {}) => {
  // 开发环境：使用本地 WAP-Vue 服务器
  if (import.meta.env.MODE === 'development') {
    const options = {
      protocol: 'http',
      domain: 'localhost',
      port: '333'
    };
    return generateUrl(`/syn${path}`, params, options);
  }
  
  // 生产环境：使用生产域名
  return generateUrl(`/syn${path}`, params);
};
```

**关键点**：
- ✅ 在开发模式下，生成 `http://localhost:333/syn/...` 格式的 URL
- ✅ 在生产模式下，生成 `https://jpmx.xyz/syn/...` 格式的 URL
- ✅ 正确处理查询参数位置（在 `#` 之前）

---

#### 2. **h5-vue/src/App.vue** ✅
**功能**：获取当前语言，映射为 WAP-Vue 语言代码，跳转时携带参数

```javascript
// 语言代码映射（h5-vue到wap-vue）
const getWapLanguageCode = (h5LangCode) => {
  const langMap = {
    'en-US': 'en',
    'ja-JP': 'Japanese',
    'ko-KR': 'Korean',
    'th-TH': 'th',
    'vi-VN': 'vi',
    'de-DE': 'de',
    'es-ES': 'es',
    'fr-FR': 'fr',
    'it-IT': 'Italy',
    'pt-PT': 'pt',
    'el-GR': 'gr',
    'zh-CN': 'CN',
    'zh-TW': 'CN'
  }
  return langMap[h5LangCode] || 'en'
}

// 跳转到登录页（携带语言参数）
const goToLogin = () => {
  const langCode = getWapLanguageCode(currentLanguageCode.value)
  const loginUrl = config.URLS.LOGIN({ lang: langCode })
  console.log('🔗 跳转到登录页')
  console.log('📝 当前语言代码 (H5):', currentLanguageCode.value)
  console.log('📝 转换后语言代码 (WAP):', langCode)
  console.log('🌐 生成的登录URL:', loginUrl)
  window.location.href = loginUrl
  closeSidebar()
}

// 跳转到注册页（携带语言参数）
const goToRegister = () => {
  const langCode = getWapLanguageCode(currentLanguageCode.value)
  const registerUrl = config.URLS.REGISTER({ lang: langCode })
  console.log('🔗 跳转到注册页')
  console.log('📝 当前语言代码 (H5):', currentLanguageCode.value)
  console.log('📝 转换后语言代码 (WAP):', langCode)
  console.log('🌐 生成的注册URL:', registerUrl)
  window.location.href = registerUrl
  closeSidebar()
}
```

**关键点**：
- ✅ 获取当前选择的语言代码
- ✅ 映射为 WAP-Vue 兼容的语言代码
- ✅ 使用 `config.URLS.LOGIN()` 和 `config.URLS.REGISTER()` 生成 URL
- ✅ 打印详细日志，便于调试

---

#### 3. **wap-vue/src/utils/languageInit.js** ✅
**功能**：接收 URL 中的语言参数，设置为当前语言

```javascript
/**
 * 从URL获取语言参数
 */
export function getLanguageFromUrl() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const langParam = urlParams.get('lang');
    if (langParam) {
      console.log('🌐 WAP-Vue: 从URL获取到语言参数:', langParam);
      return langParam;
    }
    return null;
  } catch (error) {
    console.error('🌐 WAP-Vue: 获取URL语言参数失败:', error);
    return null;
  }
}

/**
 * 强制初始化英文语言
 * 如果URL中有语言参数，则使用URL参数的语言
 */
export function forceInitializeEnglish() {
  try {
    console.log('🌐 WAP-Vue: 开始语言初始化...');
    
    // 首先检查URL参数中是否有语言设置
    const urlLang = getLanguageFromUrl();
    if (urlLang) {
      console.log('🌐 WAP-Vue: 检测到URL语言参数，设置语言为:', urlLang);
      localStorage.setItem('lang', urlLang);
      localStorage.setItem('userSetLanguage', 'true'); // 标记为用户设置
      localStorage.setItem('langSource', 'url'); // 标记语言来源
      return true;
    }
    
    // ... 其他逻辑
  } catch (error) {
    console.error('🌐 WAP-Vue: 语言初始化失败:', error);
    return false;
  }
}
```

**关键点**：
- ✅ 优先从 URL 参数获取语言设置
- ✅ 设置 `localStorage.setItem('lang', urlLang)` 保存语言
- ✅ 标记 `langSource: 'url'` 用于追踪来源
- ✅ 标记 `userSetLanguage: 'true'` 防止被覆盖

---

#### 4. **wap-vue/src/App.vue** ✅
**功能**：启动时调用语言初始化，应用 URL 参数

```javascript
onMounted(() => {
  console.log('🚀 WAP-Vue 应用启动');
  const firstVisit = isFirstVisit();
  if (firstVisit) {
    console.log('👋 首次访问 WAP-Vue，欢迎！');
  }
  const languageResult = initializeWapLanguage();
  console.log('🌐 语言初始化结果:', languageResult);
  
  const urlParams = new URLSearchParams(window.location.search);
  const langParam = urlParams.get('lang');
  if (langParam) {
    console.log('🌐 从H5页面接收到语言参数:', langParam);
    console.log('🌐 已自动切换到指定语言');
  }
})
```

**关键点**：
- ✅ 启动时调用 `initializeWapLanguage()`
- ✅ 打印日志确认语言参数接收成功
- ✅ 不刷新页面，直接应用语言设置

---

## 🌍 语言代码映射表

| 语言         | H5-Vue 代码 | WAP-Vue 代码 |
|--------------|-------------|--------------|
| 英语         | `en-US`     | `en`         |
| 日语         | `ja-JP`     | `Japanese`   |
| 韩语         | `ko-KR`     | `Korean`     |
| 泰语         | `th-TH`     | `th`         |
| 越南语       | `vi-VN`     | `vi`         |
| 德语         | `de-DE`     | `de`         |
| 西班牙语     | `es-ES`     | `es`         |
| 法语         | `fr-FR`     | `fr`         |
| 意大利语     | `it-IT`     | `Italy`      |
| 葡萄牙语     | `pt-PT`     | `pt`         |
| 希腊语       | `el-GR`     | `gr`         |
| 简体中文     | `zh-CN`     | `CN`         |
| 繁体中文     | `zh-TW`     | `CN`         |

---

## 🚀 启动服务器

### 1. **启动 WAP-Vue 服务器**（端口 333）
```bash
cd D:\Awww\mt5new\template\wap-vue
yarn dev
```

### 2. **启动 H5-Vue 服务器**（端口 3333）
```bash
cd D:\Awww\mt5new\template\h5-vue
yarn dev
```

---

## 🧪 测试步骤

### 开发环境测试

1. **打开 H5-Vue 应用**
   - 访问：`http://localhost:3333/h5/`

2. **选择语言**
   - 点击右上角语言选择器
   - 选择"日本語"（Japanese）

3. **点击登录或注册**
   - 点击侧边栏的"Login Account"或"Register"按钮
   - 查看浏览器控制台日志

4. **预期结果**
   ```
   🔗 跳转到登录页
   📝 当前语言代码 (H5): ja-JP
   📝 转换后语言代码 (WAP): Japanese
   🌐 生成的登录URL: http://localhost:333/syn/?lang=Japanese#/my/index
   ```

5. **验证 WAP-Vue**
   - 自动跳转到 WAP-Vue 应用
   - 查看 WAP-Vue 控制台日志：
   ```
   🌐 WAP-Vue: 从URL获取到语言参数: Japanese
   🌐 WAP-Vue: 检测到URL语言参数，设置语言为: Japanese
   🌐 从H5页面接收到语言参数: Japanese
   🌐 已自动切换到指定语言
   ```

6. **验证语言显示**
   - WAP-Vue 页面应该显示为日语
   - 所有文本内容应该是日语

---

### 生产环境测试

1. **构建项目**
   ```bash
   # 构建 H5-Vue
   cd D:\Awww\mt5new\template\h5-vue
   yarn build
   
   # 构建 WAP-Vue
   cd D:\Awww\mt5new\template\wap-vue
   yarn build
   ```

2. **部署到服务器**
   - 将 `jar/h5/` 部署到 `https://jpmx.xyz/h5/`
   - 将 `jar/syn/` 部署到 `https://jpmx.xyz/syn/`

3. **测试生产环境**
   - 访问：`https://jpmx.xyz/h5/`
   - 选择语言：日本語
   - 点击"Login Account"
   - 验证跳转 URL：`https://jpmx.xyz/syn/?lang=Japanese#/my/index`

---

## 🔍 调试指南

### 常见问题排查

#### 问题 1：语言参数没有出现在 URL 中
**排查步骤**：
1. 检查 H5-Vue 控制台日志
2. 查看是否打印了 `🌐 生成的登录URL`
3. 确认 URL 格式是否正确（查询参数在 `#` 之前）

**解决方案**：
- 确保 `domainManager.js` 中的 `generateUrl` 函数正确处理 hash
- 验证 `params` 对象是否正确传递

---

#### 问题 2：WAP-Vue 没有接收到语言参数
**排查步骤**：
1. 检查 WAP-Vue 控制台日志
2. 查看是否打印了 `🌐 WAP-Vue: 从URL获取到语言参数`
3. 手动在浏览器中访问带参数的 URL：`http://localhost:333/syn/?lang=Japanese#/my/index`

**解决方案**：
- 确保 `languageInit.js` 中的 `getLanguageFromUrl()` 正确解析 `window.location.search`
- 验证 `forceInitializeEnglish()` 优先检查 URL 参数

---

#### 问题 3：语言设置不生效
**排查步骤**：
1. 打开浏览器开发者工具 → Application → Local Storage
2. 查看 `lang` 键的值
3. 确认值是否与 URL 参数一致

**解决方案**：
- 清除 localStorage：`localStorage.clear()`
- 刷新页面重新测试
- 验证 WAP-Vue 的 `i18n` 配置是否正确

---

#### 问题 4：开发环境跳转到生产环境
**排查步骤**：
1. 检查 `import.meta.env.MODE` 的值
2. 确认是否使用 `yarn dev` 启动（不是 `yarn build` + 静态服务器）

**解决方案**：
- 确保使用 `yarn dev` 启动开发服务器
- 检查 `vite.config.js` 中的 `mode` 配置

---

## 📊 URL 格式对比

### ✅ 正确格式
```
http://localhost:333/syn/?lang=Japanese#/my/index
                           ↑           ↑
                      查询参数在前   hash在后
```

### ❌ 错误格式
```
http://localhost:333/syn/#/my/index?lang=Japanese
                           ↑           ↑
                       hash在前    查询参数在后（无效）
```

**原因**：
- URL 中 `#` 后面的内容不会发送到服务器
- 查询参数必须在 `#` 之前才能被 `window.location.search` 读取

---

## ✅ 完成清单

- [x] 修改 `h5-vue/src/utils/domainManager.js` 支持开发/生产环境切换
- [x] 确认 `h5-vue/src/App.vue` 正确传递语言参数
- [x] 确认 `wap-vue/src/utils/languageInit.js` 正确接收语言参数
- [x] 确认 `wap-vue/src/App.vue` 正确应用语言设置
- [x] 测试 13 种语言的映射关系
- [x] 编写完整的测试文档
- [x] 提供调试指南

---

## 🎉 总结

本方案实现了从 H5-Vue 到 WAP-Vue 的无缝语言参数传递，支持：

✅ **自动环境检测**：开发环境使用 localhost，生产环境使用生产域名  
✅ **语言参数传递**：自动将语言参数附加到跳转 URL  
✅ **语言代码映射**：H5-Vue 和 WAP-Vue 语言代码自动转换  
✅ **持久化存储**：语言设置保存到 localStorage，防止丢失  
✅ **完善的日志**：详细的控制台日志，便于调试  

---

## 📞 联系支持

如果测试过程中遇到问题，请：
1. 查看浏览器控制台日志
2. 参考"调试指南"部分
3. 检查网络请求（Network Tab）
4. 验证 localStorage 内容

祝您测试顺利！ 🚀

